import { Callout, Sandpack } from '@/components'

# getQueryClient

A utility function to manage QueryClient instances in a server-safe manner.

- **On the server**: Always creates a new QueryClient instance for each request
- **In the browser**: Returns a singleton QueryClient instance, creating one if it doesn't exist

This pattern is essential for proper React Query usage with SSR frameworks like Next.js, as it prevents sharing QueryClient state between requests on the server while maintaining a single instance in the browser to preserve cache across re-renders.

## Basic Usage

```tsx /getQueryClient/
import { getQueryClient } from '@suspensive/react-query'
import { QueryClientProvider } from '@tanstack/react-query'

function Providers({ children }: { children: React.ReactNode }) {
  const queryClient = getQueryClient()
  return (
    <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
  )
}
```

## Configuration

You can pass a `QueryClientConfig` to customize the QueryClient instance:

```tsx /getQueryClient/
import { getQueryClient } from '@suspensive/react-query'
import { QueryClientProvider } from '@tanstack/react-query'

function Providers({ children }: { children: React.ReactNode }) {
  const queryClient = getQueryClient({
    defaultOptions: {
      queries: {
        staleTime: 5000,
        retry: 3,
      },
    },
  })
  return (
    <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
  )
}
```

<Callout type='warning'>

**Browser Environment Behavior**

In the browser environment, the config parameter is only used when creating the initial QueryClient instance. Subsequent calls with different configs will return the existing instance and the new config will be ignored. This is intentional to maintain a stable singleton across re-renders.

</Callout>

## Server-Side Behavior

### Automatic cacheTime/gcTime Setting

<Callout type='important'>

**OOM Prevention on Server**

On the server, `getQueryClient` automatically sets `cacheTime` (v4) or `gcTime` (v5) to `Infinity` to prevent Out of Memory (OOM) issues. This is a critical safety measure because:

1. **Server environments handle multiple concurrent requests**: Unlike browsers where each user has their own isolated context, servers process many requests simultaneously. If cache entries are garbage collected too early, the server might need to refetch the same data multiple times for different requests, leading to unnecessary memory usage and potential OOM.

2. **Request isolation**: Each server request gets its own QueryClient instance, so cache entries are automatically cleaned up when the request completes. Setting `cacheTime`/`gcTime` to `Infinity` ensures that data remains available throughout the entire request lifecycle without premature garbage collection.

3. **Memory safety**: By keeping cache entries alive for the entire request duration, we prevent the server from accumulating stale cache entries that could lead to memory leaks or OOM errors under high load.

This behavior is **automatic and cannot be overridden** - even if you provide a different `cacheTime` or `gcTime` value in your config, it will be set to `Infinity` on the server.

</Callout>

```tsx /getQueryClient/
import { getQueryClient } from '@suspensive/react-query'

// Server environment
const queryClient = getQueryClient({
  defaultOptions: {
    queries: {
      cacheTime: 5000, // This will be overridden to Infinity on server
      // or gcTime: 5000 in v5
    },
  },
})

// On server: cacheTime/gcTime is always Infinity
// On browser: cacheTime/gcTime uses the provided value (or default)
```

### New Instance Per Request

On the server, `getQueryClient` creates a new QueryClient instance for each call. This ensures that:

- Each request has isolated cache state
- No data leaks between different user requests
- Proper cleanup when the request completes

```tsx /getQueryClient/
// Server environment
const queryClient1 = getQueryClient()
const queryClient2 = getQueryClient()

// queryClient1 !== queryClient2 (different instances)
```

## Browser-Side Behavior

### Singleton Pattern

In the browser, `getQueryClient` returns the same QueryClient instance across multiple calls. This ensures:

- Cache is preserved across re-renders
- Consistent state management
- Optimal performance

```tsx /getQueryClient/
// Browser environment
const queryClient1 = getQueryClient()
const queryClient2 = getQueryClient()

// queryClient1 === queryClient2 (same instance)
```

## Complete Example

<Sandpack>

```tsx App.tsx active
import { getQueryClient } from '@suspensive/react-query'
import { QueryClientProvider } from '@tanstack/react-query'
import { PostsList } from './PostsList'

function App() {
  const queryClient = getQueryClient({
    defaultOptions: {
      queries: {
        staleTime: 1000 * 60 * 5, // 5 minutes
        retry: 1,
      },
    },
  })

  return (
    <QueryClientProvider client={queryClient}>
      <PostsList />
    </QueryClientProvider>
  )
}

export default App
```

```tsx PostsList.tsx
'use client'

import { useSuspenseQuery } from '@suspensive/react-query'

const postsQueryOptions = {
  queryKey: ['posts'] as const,
  queryFn: async () => {
    const res = await fetch('https://jsonplaceholder.typicode.com/posts')
    return res.json()
  },
}

export function PostsList() {
  const { data: posts } = useSuspenseQuery(postsQueryOptions)

  return (
    <ul>
      {posts.map((post: { id: number; title: string }) => (
        <li key={post.id}>{post.title}</li>
      ))}
    </ul>
  )
}
```

</Sandpack>

## Use Cases

### Next.js App Router

```tsx /getQueryClient/
// app/providers.tsx
'use client'

import { getQueryClient } from '@suspensive/react-query'
import { QueryClientProvider } from '@tanstack/react-query'
import { ReactNode } from 'react'

export function Providers({ children }: { children: ReactNode }) {
  const queryClient = getQueryClient()
  return (
    <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
  )
}
```

```tsx
// app/layout.tsx
import { Providers } from './providers'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en">
      <body>
        <Providers>{children}</Providers>
      </body>
    </html>
  )
}
```

### With Custom Configuration

```tsx /getQueryClient/
import { getQueryClient } from '@suspensive/react-query'
import { QueryClientProvider } from '@tanstack/react-query'

function Providers({ children }: { children: React.ReactNode }) {
  const queryClient = getQueryClient({
    defaultOptions: {
      queries: {
        staleTime: 1000 * 60 * 5, // 5 minutes
        gcTime: 1000 * 60 * 10, // 10 minutes (v5)
        // cacheTime: 1000 * 60 * 10, // 10 minutes (v4)
        retry: 2,
        refetchOnWindowFocus: false,
      },
      mutations: {
        retry: 1,
      },
    },
  })

  return (
    <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
  )
}
```

## Version Differences

### @tanstack/react-query v4

In v4, the cache time option is called `cacheTime`:

```tsx
// Server: cacheTime is automatically set to Infinity
const queryClient = getQueryClient({
  defaultOptions: {
    queries: {
      cacheTime: 5000, // Overridden to Infinity on server
    },
  },
})
```

### @tanstack/react-query v5

In v5, the cache time option is called `gcTime` (garbage collection time):

```tsx
// Server: gcTime is automatically set to Infinity
const queryClient = getQueryClient({
  defaultOptions: {
    queries: {
      gcTime: 5000, // Overridden to Infinity on server
    },
  },
})
```

## Important Notes

- **Server safety**: Always use `getQueryClient` instead of creating `new QueryClient()` directly in SSR environments to ensure proper request isolation and OOM prevention.

- **Browser singleton**: The browser instance is a singleton, so config changes after the first call are ignored. Configure your QueryClient on the first call.

- **Automatic OOM prevention**: The `cacheTime`/`gcTime` override to `Infinity` on the server is automatic and cannot be disabled. This is a safety feature to prevent memory issues.
