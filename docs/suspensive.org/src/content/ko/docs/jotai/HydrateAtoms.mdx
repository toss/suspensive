import { Callout } from '@/components'

# HydrateAtoms

<Callout type="experimental">
  `HydrateAtoms`는 실험적인 기능으로 인터페이스가 변경될 수 있습니다.
</Callout>

HydrateAtoms 컴포넌트는 Jotai의 [useHydrateAtoms](https://jotai.org/docs/utilities/ssr#usehydrateatoms) 훅을 감싸는 래퍼입니다. SSR에서 가져온 초기값을 Jotai atom에 hydrate하여 서버와 클라이언트 간의 상태 불일치를 방지합니다.

### props.values

atom-value 쌍을 포함하는 배열 또는 Map을 전달하여 hydrate할 수 있습니다.

```tsx /HydrateAtoms/
import { AtomValue, HydrateAtoms } from '@suspensive/jotai'
import { atom } from 'jotai'

const userIdAtom = atom('')

// Server Component
const Page = async () => {
  const userId = await getSessionUserId()

  return (
    <HydrateAtoms values={[[userIdAtom, userId]]}>
      <AtomValue atom={userIdAtom}>
        {(userId) => <div>userId: {userId}</div>}
      </AtomValue>
    </HydrateAtoms>
  )
}
```

Map을 사용할 수도 있습니다:

```tsx /HydrateAtoms/
import { AtomValue, HydrateAtoms } from '@suspensive/jotai'
import { atom } from 'jotai'

const userIdAtom = atom('')

// Server Component
const Page = async () => {
  const userId = await getSessionUserId()
  const values = new Map([[userIdAtom, userId]])

  return (
    <HydrateAtoms values={values}>
      <AtomValue atom={userIdAtom}>
        {(userId) => <div>userId: {userId}</div>}
      </AtomValue>
    </HydrateAtoms>
  )
}
```

### props.options

hydration 동작을 설정하기 위한 옵션을 전달할 수 있습니다. 이는 `useHydrateAtoms`가 받는 것과 동일한 옵션 객체입니다.

- `store`: atom을 hydrate할 커스텀 Jotai store를 지정합니다
- `dangerouslyForceHydrate`: `true`일 경우, 이미 hydrate된 atom이라도 강제로 다시 hydrate합니다

```tsx /HydrateAtoms/
import { AtomValue, HydrateAtoms } from '@suspensive/jotai'
import { atom, createStore } from 'jotai'
import { Provider } from 'jotai/react'

const userIdAtom = atom('')
const customStore = createStore()

// Server Component
const Page = async () => {
  const userId = await getSessionUserId()

  return (
    <Provider store={customStore}>
      <HydrateAtoms
        values={[[userIdAtom, userId]]}
        options={{ store: customStore, dangerouslyForceHydrate: true }}
      >
        <AtomValue atom={userIdAtom}>
          {(userId) => <div>userId: {userId}</div>}
        </AtomValue>
      </HydrateAtoms>
    </Provider>
  )
}
```

### props.children

children은 atom이 hydrate된 후 렌더링됩니다.

```tsx /HydrateAtoms/
import { AtomValue, HydrateAtoms } from '@suspensive/jotai'
import { atom } from 'jotai'

const userIdAtom = atom('')

// Server Component
const Page = async () => {
  const userId = await getSessionUserId()

  return (
    <HydrateAtoms values={[[userIdAtom, userId]]}>
      <AtomValue atom={userIdAtom}>
        {(userId) => <div>userId: {userId}</div>}
      </AtomValue>
    </HydrateAtoms>
  )
}
```

### 동기

Jotai로 SSR 애플리케이션을 구축할 때, hydration 불일치를 방지하기 위해 서버의 초기 atom 값이 클라이언트와 일치하도록 해야 합니다.

HydrateAtoms 없이는 서버 사이드 데이터가 필요한 모든 컴포넌트에서 수동으로 `useHydrateAtoms`를 호출해야 합니다:

```tsx
// HydrateAtoms 없이 - 수동 hydration 필요
import { useHydrateAtoms } from 'jotai/utils'
import { atom, useAtomValue } from 'jotai'

const userIdAtom = atom('')

// Server Component
const Page = async () => {
  const userId = await getSessionUserId()

  return <UserInfo userId={userId} />
}

// Client Component
const UserInfo = ({ userId }: { userId: string }) => {
  useHydrateAtoms([[userIdAtom, userId]])
  const visibleUserId = useAtomValue(userIdAtom)

  return <div>userId: {visibleUserId}</div>
}
```

HydrateAtoms를 사용하면 컴포넌트 트리의 경계에서 선언적으로 atom을 hydrate할 수 있습니다:

```tsx /HydrateAtoms/
// HydrateAtoms 사용 - 선언적 hydration
import { AtomValue, HydrateAtoms } from '@suspensive/jotai'
import { atom } from 'jotai'

const userIdAtom = atom('')

// Server Component
const Page = async () => {
  const userId = await getSessionUserId()

  return (
    <HydrateAtoms values={[[userIdAtom, userId]]}>
      <AtomValue atom={userIdAtom}>
        {(userId) => <div>userId: {userId}</div>}
      </AtomValue>
    </HydrateAtoms>
  )
}
```

### Suspense와 함께 사용

hydrate된 값에 의존하는 async atom을 사용할 때, HydrateAtoms와 Suspense를 함께 사용할 수 있습니다. 서버에서 hydrate된 값은 동기적으로 사용 가능하며, 이를 기반으로 클라이언트에서 추가 데이터를 fetch하는 async atom은 Suspense를 트리거합니다.

```tsx /HydrateAtoms/
import { Atom, HydrateAtoms } from '@suspensive/jotai'
import { Suspense } from '@suspensive/react'
import { atom } from 'jotai'

const userIdAtom = atom('')
const userDetailAtom = atom(async (get) => {
  const userId = get(userIdAtom)
  return await fetchUserDetail(userId)
})

// Server Component
const Page = async () => {
  const userId = await getSessionUserId()

  return (
    <HydrateAtoms values={[[userIdAtom, userId]]}>
      <Suspense fallback={'pending...'}>
        <Atom atom={userDetailAtom}>{([user]) => <div>{user.name}</div>}</Atom>
      </Suspense>
    </HydrateAtoms>
  )
}
```
