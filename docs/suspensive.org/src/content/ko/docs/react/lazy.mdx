# lazy

> **⚠️ 실험적**: 이것은 매우 실험적인 기능입니다. 프로덕션 환경에서 사용할 때 주의하세요.

`lazy` 함수는 컴포넌트 로딩이 실패할 때 자동 오류 복구를 제공하는 React의 `lazy` 함수의 안전한 래퍼입니다. 컴포넌트를 로드하려고 시도하고, 로딩이 실패하면 페이지를 한 번 새로고침하여 다시 시도하여 네트워크 문제나 일시적인 로딩 실패 시 더 나은 사용자 경험을 제공합니다.

## Import

```tsx
import { lazy } from '@suspensive/react'
```

## 기본 사용법

```tsx
const MyComponent = lazy(() => import('./MyComponent'))
```

## 작동 방식

1. **첫 번째 시도**: 컴포넌트가 처음 로드에 실패할 때, `lazy`는:

   - 실패를 추적하기 위해 `sessionStorage`에 플래그를 설정
   - 새로운 로드를 시도하기 위해 페이지를 새로고침
   - 렌더링 오류를 방지하기 위해 null 컴포넌트를 반환

2. **두 번째 시도**: 페이지 새로고침 후에도 컴포넌트 로드가 실패하면:
   - 원래 오류를 던짐
   - 더 이상의 복구 시도는 하지 않음

## 동작

- **성공**: 컴포넌트가 정상적으로 로드됨, `React.lazy`와 동일
- **첫 번째 실패**: 페이지가 자동으로 새로고침됨, 사용자는 짧은 새로고침을 경험
- **두 번째 실패**: 오류가 던져져서 오류 경계가 처리할 수 있음

## 예제

### 기본 컴포넌트 로딩

```tsx
import { lazy } from '@suspensive/react'

const UserProfile = lazy(() => import('./UserProfile'), { safe: true })

function App() {
  return (
    <div>
      <UserProfile />
    </div>
  )
}
```

### 오류 경계와 함께 사용

```tsx
import { lazy, ErrorBoundary } from '@suspensive/react'

const Dashboard = lazy(() => import('./Dashboard'), { safe: true })

function App() {
  return (
    <ErrorBoundary fallback={<div>문제가 발생했습니다</div>}>
      <Dashboard />
    </ErrorBoundary>
  )
}
```

### 여러 컴포넌트

```tsx
import { lazy } from '@suspensive/react'

const Header = lazy(() => import('./Header'), { safe: true })
const Sidebar = lazy(() => import('./Sidebar'), { safe: true })
const MainContent = lazy(() => import('./MainContent'), { safe: true })

function App() {
  return (
    <div>
      <Header />
      <Sidebar />
      <MainContent />
    </div>
  )
}
```

## API 참조

### `lazy<T>(importFunction)`

자동 오류 복구 기능이 있는 지연 로드 컴포넌트를 생성합니다.

#### 매개변수

- `importFunction`: `() => Promise<{ default: T }>` - 기본 내보내기가 있는 모듈로 해결되는 프로미스를 반환하는 함수

#### 반환값

- `LazyExoticComponent<T>` - 다른 컴포넌트처럼 렌더링할 수 있는 React 지연 컴포넌트

#### 타입 매개변수

- `T`: `ComponentType<any>` - 로드되는 컴포넌트의 타입

## 저장소 키

함수는 로딩 실패를 추적하기 위해 `sessionStorage`를 사용합니다. 저장소 키는 `importFunction.toString()`에서 생성되며, 이는 다음을 의미합니다:

- 다른 import 함수는 다른 저장소 키를 가집니다
- 같은 import 함수는 렌더링 간에 같은 저장소 키를 공유합니다
- 세션이 끝나면 저장소가 지워집니다

## 제한사항

- **브라우저 전용**: `window.sessionStorage`와 `window.location`이 필요합니다
- **세션 저장소**: 복구 상태는 브라우저 세션에 연결됩니다
- **페이지 새로고침**: 복구 메커니즘은 전체 페이지 새로고침을 포함합니다
- **실험적**: 이 기능은 아직 실험적이며 변경될 수 있습니다

## 언제 사용할까

다음과 같은 경우에 `lazy`를 사용하세요:

- 일시적인 네트워크 문제로부터 자동으로 복구되도록 하고싶을 때
- 컴포넌트 로딩 실패 시 사용자 경험을 개선하고 싶을 때
- 외부 요인으로 인해 컴포넌트 로딩이 실패할 수 있는 경우를 처리하고 싶을 때

## 언제 사용하지 말아야 할까

다음과 같은 경우에는 `lazy`를 사용하지 말아야 합니다:

- 오류 처리에 세밀한 제어가 필요할 때
- 사용 사례에서 페이지 새로고침이 허용되지 않을 때
- 서버 사이드 렌더링 환경에 있을 때
- sessionStorage를 지원하지 않는 브라우저를 지원해야 할 때

## React.lazy에서 마이그레이션

```tsx
// 이전
const Component = lazy(() => import('./Component'))

// 이후
const Component = lazy(() => import('./Component'))
```

API는 `React.lazy`와 동일하므로 기존 지연 컴포넌트를 `lazy`로 쉽게 교체하여 자동 오류 복구를 사용할 수 있습니다.
