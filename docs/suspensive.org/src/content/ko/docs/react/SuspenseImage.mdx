import { Callout, Sandpack } from '@/components'

# SuspenseImage

<Callout type='experimental'>

`SuspenseImage`는 실험 기능이므로 이 인터페이스는 변경될 수 있습니다.

</Callout>

Suspense를 지원하여 이미지를 비동기로 로드하는 컴포넌트와 훅입니다.

- 내부 캐시를 사용하여 동일한 이미지를 여러 번 다시 로드하는 것을 방지합니다.
- Suspense를 발생시켜 이미지가 로드될 때까지 렌더링을 중단합니다.
- SSR 환경에서는 서버 렌더링된 `<img>` 태그를 반환합니다.

## SuspenseImage

이미지를 비동기로 로드하고 이미지가 로드될 때까지 렌더링을 중단합니다. Render Prop 패턴을 사용하여 로드된 이미지 요소를 제공합니다.

```tsx /SuspenseImage/
import { SuspenseImage, Suspense } from '@suspensive/react'

function App() {
  return (
    <ErrorBoundary fallback={<div>이미지를 불러올 수 없습니다</div>}>
      <Suspense fallback={<div>이미지 로딩 중...</div>}>
        <SuspenseImage src="https://example.com/image.jpg">
          {/** 이미지 로드가 성공된 상태를 보장하여 선언적으로 요소에 접근할 수 있습니다 */}
          {(img) => <img src={img.src} alt="Example" />}
        </SuspenseImage>
      </Suspense>
    </ErrorBoundary>
  )
}
```

<Sandpack>

```tsx Example.tsx active
import { SuspenseImage, Suspense } from '@suspensive/react'

export function App() {
  return (
    <Suspense fallback={<div style={{ padding: 20 }}>이미지 로딩 중...</div>}>
      <SuspenseImage src="https://picsum.photos/400/300">
        {(img) => (
          <img
            src={img.src}
            alt="Example"
            style={{ maxWidth: '100%', height: 'auto' }}
          />
        )}
      </SuspenseImage>
    </Suspense>
  )
}
```

</Sandpack>

## useSuspenseImage

이미지를 비동기로 로드하고 이미지가 로드될 때까지 컴포넌트를 중단합니다. 로드된 `HTMLImageElement`를 직접 반환합니다.

```tsx /useSuspenseImage/
import { useSuspenseImage, Suspense } from '@suspensive/react'

function ImageComponent() {
  // Suspense를 발생시켜 이미지가 로드될 때까지 컴포넌트 렌더를 중단합니다.
  const img = useSuspenseImage('https://example.com/image.jpg')

  return <img src={img.src} alt="Example" />
}

function App() {
  return (
    <ErrorBoundary fallback={<div>이미지를 불러올 수 없습니다</div>}>
      <Suspense fallback={<div>이미지 로딩 중...</div>}>
        <ImageComponent />
      </Suspense>
    </ErrorBoundary>
  )
}
```

<Sandpack>

```tsx Example.tsx active
import { useSuspenseImage, Suspense } from '@suspensive/react'

function ImageComponent() {
  const img = useSuspenseImage('https://picsum.photos/400/300')

  return (
    <img
      src={img.src}
      alt="Example"
      style={{ maxWidth: '100%', height: 'auto' }}
    />
  )
}

export function App() {
  return (
    <Suspense fallback={<div style={{ padding: 20 }}>이미지 로딩 중...</div>}>
      <ImageComponent />
    </Suspense>
  )
}
```

</Sandpack>

## 이미지 캐싱

`SuspenseImage`와 `useSuspenseImage` 모두 내부 캐시를 사용하여 동일한 이미지를 여러 번 다시 로드하는 것을 방지합니다. 이미지가 한 번 로드되면, 동일한 이미지에 대한 후속 요청은 캐시된 버전을 사용합니다.

```tsx /caching/
import { useSuspenseImage, Suspense } from '@suspensive/react'

function MultipleImages() {
  const img1 = useSuspenseImage('https://example.com/image.jpg')
  const img2 = useSuspenseImage('https://example.com/image.jpg') // 캐시 사용

  return (
    <>
      <img src={img1.src} alt="Image 1" />
      <img src={img2.src} alt="Image 2" />
    </>
  )
}
```

## 서버사이드 렌더링 (SSR)

SSR 환경에서 `SuspenseImage`와 `useSuspenseImage`는 중단 대신 즉시 임시 태그를 반환합니다. 이렇게 하면 SEO를 위해 서버 렌더링된 HTML에 `<img>` 태그가 포함됩니다.

임시 태그는 `src` 속성을 가진 객체로, `complete` 속성은 `false`입니다:

```tsx
{ src: string, complete: false } as HTMLImageElement
```

이를 통해 초기 HTML에 이미지 태그가 존재하면서, 실제 이미지 로딩은 클라이언트 측에서 발생합니다.

## 주의사항

- 내부 캐시는 메모리에만 존재하며, 페이지 새로고침 시 초기화됩니다.

## 버전 기록

| Version | Changes                                            |
| ------- | -------------------------------------------------- |
| v3.18.0 | `<SuspenseImage/>`가 실험 기능으로 추가되었습니다. |
