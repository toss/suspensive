import { Callout, Sandpack } from '@/components'
import { Tabs } from '@/components/mdx'

# QueriesHydration

<Callout type='experimental'>

`<QueriesHydration/>`ëŠ” ì‹¤í—˜ ê¸°ëŠ¥ì´ë¯€ë¡œ ì´ ì¸í„°í˜ì´ìŠ¤ëŠ” ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

</Callout>

ì„œë²„ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì—¬ëŸ¬ ê°œì˜ ì¿¼ë¦¬ë¥¼ ë¯¸ë¦¬ ë¶ˆëŸ¬ì˜¤ê³  í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ì— ìë™ìœ¼ë¡œ hydrateí•˜ëŠ” ì»´í¬ë„ŒíŠ¸ì…ë‹ˆë‹¤.

React Server Componentsë¥¼ ì‚¬ìš©í•˜ëŠ” í™˜ê²½ì—ì„œ ì„œë²„ ì¸¡ì—ì„œ ë°ì´í„°ë¥¼ ë¯¸ë¦¬ ë¶ˆëŸ¬ì™€ í´ë¼ì´ì–¸íŠ¸ë¡œ ì „ë‹¬í•  ë•Œ ìœ ìš©í•©ë‹ˆë‹¤.

> ğŸ’¡ **ì¶”ì²œ ì½ê¸°**: ì´ ì»´í¬ë„ŒíŠ¸ë¥¼ ì‚¬ìš©í•˜ê¸° ì „ì— [TanStack Query Advanced Server Rendering ê°€ì´ë“œ](https://tanstack.com/query/latest/docs/framework/react/guides/advanced-ssr)ë¥¼ ì½ì–´ë³´ì‹œëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤. ì´ ê°€ì´ë“œëŠ” Server Components, streaming, ê·¸ë¦¬ê³  Next.js App Routerì— ëŒ€í•´ ë‹¤ë£¹ë‹ˆë‹¤. ì´ëŸ¬í•œ ê°œë…ì„ ì´í•´í•˜ë©´ `QueriesHydration`ë¥¼ í›¨ì”¬ ë” í¸í•˜ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

## ê¸°ë³¸ ì‚¬ìš©ë²•

<Tabs items={['page.tsx (RSC)', 'UserProfile.tsx (RCC)', 'PostList.tsx (RCC)']}>
<Tabs.Tab>

```tsx /QueriesHydration/
import { QueriesHydration } from '@suspensive/react-query'
import { Suspense } from '@suspensive/react'
import { userQueryOptions, postsQueryOptions } from './queries'
import { UserProfile, PostList } from './_components'

// ì„œë²„ ì»´í¬ë„ŒíŠ¸
const PostsPage = ({ userId }) => {
  return (
    <>
      <Suspense fallback={<div>Loading user...</div>}>
        <QueriesHydration queries={[userQueryOptions(userId)]}>
          <UserProfile userId={userId} />
        </QueriesHydration>
      </Suspense>
      <Suspense fallback={<div>Loading posts...</div>}>
        <QueriesHydration queries={[postsQueryOptions(userId)]}>
          <PostList userId={userId} />
        </QueriesHydration>
      </Suspense>
    </>
  )
}
```

</Tabs.Tab>
<Tabs.Tab>

```tsx
'use client'

import { useSuspenseQuery } from '@suspensive/react-query'
import { userQueryOptions } from './queries'

export const UserProfile = ({ userId }: { userId: number }) => {
  // ì„œë²„ì—ì„œ ë¯¸ë¦¬ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ hydrateë©ë‹ˆë‹¤
  const { data: user } = useSuspenseQuery(userQueryOptions(userId))

  return (
    <div>
      <h1>{user.name}</h1>
      <p>{user.email}</p>
    </div>
  )
}
```

</Tabs.Tab>
<Tabs.Tab>

```tsx
'use client'

import { useSuspenseQuery } from '@suspensive/react-query'
import { postsQueryOptions } from './queries'

export const PostList = ({ userId }: { userId: number }) => {
  // ì„œë²„ì—ì„œ ë¯¸ë¦¬ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ hydrateë©ë‹ˆë‹¤
  const { data: posts } = useSuspenseQuery(postsQueryOptions(userId))

  return (
    <ul>
      {posts.map((post) => (
        <li key={post.id}>{post.title}</li>
      ))}
    </ul>
  )
}
```

</Tabs.Tab>
</Tabs>

## Props

### queries

ì„œë²„ì—ì„œ ë¯¸ë¦¬ ë¶ˆëŸ¬ì˜¬ ì¿¼ë¦¬ë“¤ì˜ ë°°ì—´ì…ë‹ˆë‹¤. ê° ì¿¼ë¦¬ëŠ” `queryKey`ë¥¼ í•„ìˆ˜ë¡œ ê°€ì ¸ì•¼ í•©ë‹ˆë‹¤.

```tsx
type QueriesHydrationProps = {
  queries: WithRequired<QueryOptions<any, any, any, any>, 'queryKey'>[]
  children: ReactNode
  queryClient?: QueryClient // ì„ íƒì‚¬í•­ (ê¸°ë³¸ê°’: new QueryClient())
  skipSsrOnError?: boolean | { fallback: ReactNode } // ì„ íƒì‚¬í•­ (ê¸°ë³¸ê°’: true)
}
```

### queryClient

ì„ íƒì ìœ¼ë¡œ ì‚¬ìš©í•  QueryClient ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì „ë‹¬í•˜ì§€ ì•Šìœ¼ë©´ ìƒˆë¡œìš´ QueryClient ì¸ìŠ¤í„´ìŠ¤ê°€ ìƒì„±ë©ë‹ˆë‹¤.

```tsx /QueriesHydration/
import { QueryClient } from '@tanstack/react-query'
import { QueriesHydration } from '@suspensive/react-query'

const queryClient = new QueryClient()

const Page = async () => {
  return (
    <QueriesHydration queryClient={queryClient} queries={[]}>
      {/* ... */}
    </QueriesHydration>
  )
}
```

### skipSsrOnError

ì„œë²„ì—ì„œ ì¿¼ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆì„ ë•Œì˜ ë™ì‘ì„ ì œì–´í•©ë‹ˆë‹¤. ì´ ì˜µì…˜ì€ ë°ì´í„° í˜ì¹­ì´ ë°œìƒí•˜ëŠ” 3ë‹¨ê³„ ì‹œì ì„ ì´í•´í•˜ë©´ ë” ëª…í™•í•©ë‹ˆë‹¤:

1. **RSC(React Server Component)**: `QueriesHydration`ì—ì„œ ì¿¼ë¦¬ ì‹¤í–‰
2. **RCC(React Client Component) - Server**: `useSuspenseQuery`ì—ì„œ ìºì‹œëœ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì¿¼ë¦¬ ì‹¤í–‰
3. **RCC(React Client Component) - Browser**: `useSuspenseQuery`ì—ì„œ ìºì‹œë‚˜ freshí•œ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì¿¼ë¦¬ ì‹¤í–‰

1ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨í•˜ë©´ 2ë‹¨ê³„ë„ ê°™ì€ ì›ì¸ìœ¼ë¡œ ì‹¤íŒ¨í•  ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ 3ë‹¨ê³„(ë¸Œë¼ìš°ì €)ì—ì„œëŠ” ì„±ê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì˜ˆ: ì¸ì¦ ê´€ë ¨ ì´ìŠˆ ë“±). ë¸Œë¼ìš°ì €ì—ì„œëŠ” ì¬ì‹œë„ë¥¼ í†µí•´ ë‹¤ì‹œ ì„±ê³µí•  ê°€ëŠ¥ì„±ì´ ìˆì–´, `skipSsrOnError`ë¥¼ í†µí•´ RSCì—ì„œ ì‹¤íŒ¨í–ˆë‹¤ë©´ RCC(server)ë¥¼ í†µí•˜ì§€ ì•Šê³  ë°”ë¡œ RCC(browser)ì—ì„œ í˜ì¹­í•˜ë„ë¡ í•˜ëŠ” ê²ƒì´ ë” ì¢‹ìŠµë‹ˆë‹¤.

**ì¤‘ìš”**: 1ë‹¨ê³„ì—ì„œ ì„±ê³µí•œ ê²½ìš°(ì—ëŸ¬ ì—†ìŒ), ë°ì´í„°ëŠ” ì´ë¯¸ í´ë¼ì´ì–¸íŠ¸ì— hydrateë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì´ ê²½ìš° ë¸Œë¼ìš°ì €ì˜ ê°œë°œìë„êµ¬ ë„¤íŠ¸ì›Œí¬ íƒ­ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆë“¯ì´ 2ë‹¨ê³„ì™€ 3ë‹¨ê³„ì—ì„œ ì¶”ê°€ì ì¸ fetch ìš”ì²­ì´ ë°œìƒí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë°ì´í„°ê°€ ìºì‹œì—ì„œ ì œê³µë˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ì´ê²ƒì´ `QueriesHydration`ë¥¼ ì‚¬ìš©í•œ ì„œë²„ ì‚¬ì´ë“œ prefetchingì˜ íš¨ìœ¨ì„±ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.

- `true` (ê¸°ë³¸ê°’): 1ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨í•˜ë©´ SSRì„ ê±´ë„ˆë›°ê³  3ë‹¨ê³„(ë¸Œë¼ìš°ì €)ì—ì„œ ì¬ì‹œë„í•©ë‹ˆë‹¤
- `false`: 1ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨í•´ë„ hydration ì—†ì´ 2ë‹¨ê³„ë¡œ ì§„í–‰í•©ë‹ˆë‹¤ (ì„œë²„ì—ì„œ ë‹¤ì‹œ í˜ì¹­ ì‹œë„)
- `{ fallback: ReactNode }`: 1ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨í•˜ë©´ SSRì„ ê±´ë„ˆë›°ê³  3ë‹¨ê³„ë¡œ ê°€ëŠ” ë™ì•ˆ ì»¤ìŠ¤í…€ í´ë°± UIë¥¼ í‘œì‹œí•©ë‹ˆë‹¤

```tsx /QueriesHydration/
import { QueriesHydration } from '@suspensive/react-query'
import { Suspense } from '@suspensive/react'
import {
  userQueryOptions,
  postsQueryOptions,
  commentsQueryOptions,
} from './queries'
import { UserProfile, PostList, CommentList } from './_components'

const Page = async ({ userId }: { userId: number }) => {
  return (
    <>
      {/* 1ë‹¨ê³„ ì‹¤íŒ¨ ì‹œ SSRì„ ê±´ë„ˆë›°ê³  ë¸Œë¼ìš°ì €ì—ì„œ ì¬ì‹œë„ (ê¸°ë³¸ ë™ì‘) */}
      <Suspense fallback={<div>Loading...</div>}>
        <QueriesHydration queries={[userQueryOptions(userId)]}>
          <UserProfile />
        </QueriesHydration>
      </Suspense>

      {/* 1ë‹¨ê³„ ì‹¤íŒ¨ ì‹œ ì»¤ìŠ¤í…€ í´ë°±ê³¼ í•¨ê»˜ SSRì„ ê±´ë„ˆë›°ê³  ë¸Œë¼ìš°ì €ì—ì„œ ì¬ì‹œë„ */}
      <Suspense fallback={<div>Loading...</div>}>
        <QueriesHydration
          queries={[postsQueryOptions()]}
          skipSsrOnError={{
            fallback: <div>ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤...</div>,
          }}
        >
          <PostList />
        </QueriesHydration>
      </Suspense>

      {/* 1ë‹¨ê³„ ì‹¤íŒ¨ ì‹œì—ë„ 2ë‹¨ê³„(RCC server)ì—ì„œ ì¬ì‹œë„ */}
      <Suspense fallback={<div>Loading...</div>}>
        <QueriesHydration
          queries={[commentsQueryOptions()]}
          skipSsrOnError={false}
        >
          <CommentList />
        </QueriesHydration>
      </Suspense>
    </>
  )
}
```

## ë™ê¸°: ì„œë²„ ì»´í¬ë„ŒíŠ¸ì—ì„œ ì—¬ëŸ¬ ì¿¼ë¦¬ë¥¼ ê°„í¸í•˜ê²Œ í”„ë¦¬í˜ì¹­í•˜ê¸°

React Server Components í™˜ê²½ì—ì„œëŠ” ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ ë¯¸ë¦¬ ë¶ˆëŸ¬ì™€ ì´ˆê¸° ë¡œë”© ìƒíƒœë¥¼ ì œê±°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì—¬ëŸ¬ ê°œì˜ ì¿¼ë¦¬ë¥¼ ìˆ˜ë™ìœ¼ë¡œ prefetchí•˜ê³  dehydrateí•˜ëŠ” ì‘ì—…ì€ ë²ˆê±°ë¡­ìŠµë‹ˆë‹¤.

### ê¸°ì¡´ ë°©ì‹: ìˆ˜ë™ìœ¼ë¡œ prefetch ë° dehydrate

<Tabs items={['page.tsx (RSC)', 'UserProfile.tsx (RCC)', 'PostList.tsx (RCC)']}>
  <Tabs.Tab>

```tsx
import {
  QueryClient,
  dehydrate,
  HydrationBoundary,
} from '@tanstack/react-query'
import { Suspense } from '@suspensive/react'
import { userQueryOptions, postsQueryOptions } from './queries'
import { UserProfile, PostList } from './_components'

// ì„œë²„ ì»´í¬ë„ŒíŠ¸
const PostsPage = ({ userId }: { userId: number }) => {
  return (
    <>
      <Suspense fallback={<div>Loading user...</div>}>
        <UserProfileWithData userId={userId} />
      </Suspense>
      <Suspense fallback={<div>Loading posts...</div>}>
        <PostListWithData userId={userId} />
      </Suspense>
    </>
  )
}

// HTML Streamingì„ ìœ„í•´ ê° ì„œë²„ ì»´í¬ë„ŒíŠ¸ë¥¼ ë¶„ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤
const UserProfileWithData = async ({ userId }: { userId: number }) => {
  const queryClient = new QueryClient()
  try {
    await queryClient.ensureQueryData(userQueryOptions(userId))
  } catch (error) {
    return (
      // queryClient.ensureQueryData ì‹¤íŒ¨ ì‹œ ClientOnlyë¥¼ ì‚¬ìš©í•˜ì—¬ SSRì„ ë§‰ê³  ë¸Œë¼ìš°ì €ì—ì„œ ë°”ë¡œ ë Œë”ë§
      <ClientOnly fallback={<div>Loading user...</div>}>
        <UserProfile userId={userId} />
      </ClientOnly>
    )
  }
  return (
    <HydrationBoundary state={dehydrate(queryClient)}>
      <UserProfile userId={userId} />
    </HydrationBoundary>
  )
}

const PostListWithData = async ({ userId }: { userId: number }) => {
  const queryClient = new QueryClient()
  try {
    await queryClient.ensureQueryData(postsQueryOptions(userId))
  } catch (error) {
    return (
      // queryClient.ensureQueryData ì‹¤íŒ¨ ì‹œ ClientOnlyë¥¼ ì‚¬ìš©í•˜ì—¬ SSRì„ ë§‰ê³  ë¸Œë¼ìš°ì €ì—ì„œ ë°”ë¡œ ë Œë”ë§
      <ClientOnly fallback={<div>Loading posts...</div>}>
        <PostList userId={userId} />
      </ClientOnly>
    )
  }
  return (
    <HydrationBoundary state={dehydrate(queryClient)}>
      <PostList userId={userId} />
    </HydrationBoundary>
  )
}
```

</Tabs.Tab>
<Tabs.Tab>

```tsx
'use client'

import { useSuspenseQuery } from '@suspensive/react-query'
import { userQueryOptions } from './queries'

export const UserProfile = ({ userId }: { userId: number }) => {
  const { data: user } = useSuspenseQuery(userQueryOptions(userId))

  return (
    <div>
      <h1>{user.name}</h1>
      <p>{user.email}</p>
    </div>
  )
}
```

</Tabs.Tab>
<Tabs.Tab>

```tsx
'use client'

import { useSuspenseQuery } from '@suspensive/react-query'
import { postsQueryOptions } from './queries'

export const PostList = ({ userId }: { userId: number }) => {
  const { data: posts } = useSuspenseQuery(postsQueryOptions(userId))

  return (
    <ul>
      {posts.map((post) => (
        <li key={post.id}>{post.title}</li>
      ))}
    </ul>
  )
}
```

</Tabs.Tab>
</Tabs>

### QueriesHydration ì‚¬ìš©

`<QueriesHydration/>`ë¥¼ ì‚¬ìš©í•˜ë©´ ì´ ëª¨ë“  ê³¼ì •ì´ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤:

<Tabs items={['page.tsx (RSC)', 'UserProfile.tsx (RCC)', 'PostList.tsx (RCC)']}>
<Tabs.Tab>

```tsx /QueriesHydration/
import { QueriesHydration } from '@suspensive/react-query'
import { Suspense } from '@suspensive/react'
import { userQueryOptions, postsQueryOptions } from './queries'
import { UserProfile, PostList } from './_components'

// ì„œë²„ ì»´í¬ë„ŒíŠ¸
const PostsPage = ({ userId }: { userId: number }) => {
  return (
    <>
      <Suspense fallback={<div>Loading user...</div>}>
        <QueriesHydration queries={[userQueryOptions(userId)]}>
          <UserProfile userId={userId} />
        </QueriesHydration>
      </Suspense>
      <Suspense fallback={<div>Loading posts...</div>}>
        <QueriesHydration queries={[postsQueryOptions(userId)]}>
          <PostList userId={userId} />
        </QueriesHydration>
      </Suspense>
    </>
  )
}
```

</Tabs.Tab>
<Tabs.Tab>

```tsx
'use client'

import { useSuspenseQuery } from '@suspensive/react-query'
import { userQueryOptions } from './queries'

export const UserProfile = ({ userId }: { userId: number }) => {
  // ì„œë²„ì—ì„œ ë¯¸ë¦¬ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ hydrateë©ë‹ˆë‹¤
  const { data: user } = useSuspenseQuery(userQueryOptions(userId))

  return (
    <div>
      <h1>{user.name}</h1>
      <p>{user.email}</p>
    </div>
  )
}
```

</Tabs.Tab>
<Tabs.Tab>

```tsx
'use client'

import { useSuspenseQuery } from '@suspensive/react-query'
import { postsQueryOptions } from './queries'

export const PostList = ({ userId }: { userId: number }) => {
  // ì„œë²„ì—ì„œ ë¯¸ë¦¬ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ hydrateë©ë‹ˆë‹¤
  const { data: posts } = useSuspenseQuery(postsQueryOptions(userId))

  return (
    <ul>
      {posts.map((post) => (
        <li key={post.id}>{post.title}</li>
      ))}
    </ul>
  )
}
```

</Tabs.Tab>
</Tabs>

ì£¼ìš” ì´ì :

1. **ê°„ê²°í•œ ì½”ë“œ**: QueryClient ìƒì„±, prefetch, dehydrate ê³¼ì •ì„ ìë™í™”
2. **ë³‘ë ¬ ë°ì´í„° í˜ì¹­**: `Promise.all`ì„ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ì¿¼ë¦¬ë¥¼ ë³‘ë ¬ë¡œ ì²˜ë¦¬
3. **íƒ€ì… ì•ˆì „ì„±**: queryKeyê°€ í•„ìˆ˜ë¡œ ìš”êµ¬ë˜ì–´ ì‹¤ìˆ˜ë¥¼ ë°©ì§€
4. **ì¼ê´€ëœ íŒ¨í„´**: ì—¬ëŸ¬ ì¿¼ë¦¬ë¥¼ ì¼ê´€ë˜ê²Œ ì²˜ë¦¬

## Dependent Queriesì™€ Streaming

Dependent queries(ì˜ì¡´ì  ì¿¼ë¦¬)ë¥¼ ì²˜ë¦¬í•˜ë©´ì„œë„ ê° ì»´í¬ë„ŒíŠ¸ë¥¼ ë³„ë„ì˜ `QueriesHydration`ìœ¼ë¡œ ê°ì‹¸ë©´ ë…ë¦½ì ì¸ Suspense ê²½ê³„ë¡œ Streamingì˜ ì´ì ì„ ìµœëŒ€í™”í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê°™ì€ `queryClient`ë¥¼ ê³µìœ í•˜ì—¬ ì²« ë²ˆì§¸ ì¿¼ë¦¬ ê²°ê³¼ë¥¼ ë‘ ë²ˆì§¸ ì¿¼ë¦¬ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<Tabs items={['page.tsx (RSC)', 'ProductInfo.tsx (RCC)', 'ProductReviews.tsx (RCC)', 'RelatedProducts.tsx (RCC)']}>
<Tabs.Tab>

```tsx /QueriesHydration/
import { QueryClient } from '@tanstack/react-query'
import { QueriesHydration } from '@suspensive/react-query'
import { Suspense } from '@suspensive/react'
import {
  productQueryOptions,
  productReviewsQueryOptions,
  relatedProductsQueryOptions,
} from './queries'
import { ProductInfo, ProductReviews, RelatedProducts } from './_components'

const ProductPage = async ({ productId }: { productId: string }) => {
  const queryClient = new QueryClient()

  // 1. ë¨¼ì € ìƒí’ˆ ì •ë³´ë¥¼ ê°€ì ¸ì˜´
  const product = await queryClient.ensureQueryData(
    productQueryOptions(productId)
  )

  return (
    <>
      {/* ìƒí’ˆ ì •ë³´ */}
      <Suspense fallback={<div>Loading product...</div>}>
        <QueriesHydration
          queryClient={queryClient}
          queries={[productQueryOptions(productId)]}
        >
          <ProductInfo productId={productId} />
        </QueriesHydration>
      </Suspense>

      {/* ìƒí’ˆ ë¦¬ë·°: ìƒí’ˆ ì •ë³´ì— ì˜ì¡´ (ì˜ˆ: ìƒí’ˆ ì¹´í…Œê³ ë¦¬ë¡œ í•„í„°ë§) */}
      <Suspense fallback={<div>Loading reviews...</div>}>
        <QueriesHydration
          queryClient={queryClient}
          queries={[productReviewsQueryOptions(productId)]}
        >
          <ProductReviews productId={productId} />
        </QueriesHydration>
      </Suspense>

      {/* ê´€ë ¨ ìƒí’ˆ: ìƒí’ˆ ì •ë³´ì— ì˜ì¡´ (ê°™ì€ ì¹´í…Œê³ ë¦¬) */}
      <Suspense fallback={<div>Loading related products...</div>}>
        <QueriesHydration
          queryClient={queryClient}
          queries={[relatedProductsQueryOptions(product.categoryId)]}
        >
          <RelatedProducts categoryId={product.categoryId} />
        </QueriesHydration>
      </Suspense>
    </>
  )
}
```

</Tabs.Tab>
<Tabs.Tab>

```tsx
'use client'

import { useSuspenseQuery } from '@suspensive/react-query'
import { productQueryOptions } from './queries'

export const ProductInfo = ({ productId }: { productId: string }) => {
  // ì„œë²„ì—ì„œ ë¯¸ë¦¬ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ hydrateë©ë‹ˆë‹¤
  const { data: product } = useSuspenseQuery(productQueryOptions(productId))

  return (
    <div>
      <h1>{product.name}</h1>
      <p>{product.description}</p>
      <p>Price: {product.price}</p>
    </div>
  )
}
```

</Tabs.Tab>
<Tabs.Tab>

```tsx
'use client'

import { useSuspenseQuery } from '@suspensive/react-query'
import { productReviewsQueryOptions } from './queries'

export const ProductReviews = ({ productId }: { productId: string }) => {
  // ì„œë²„ì—ì„œ ë¯¸ë¦¬ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ hydrateë©ë‹ˆë‹¤
  const { data: reviews } = useSuspenseQuery(
    productReviewsQueryOptions(productId)
  )

  return (
    <div>
      <h2>Reviews</h2>
      <ul>
        {reviews.map((review) => (
          <li key={review.id}>
            <p>{review.comment}</p>
            <p>Rating: {review.rating}</p>
          </li>
        ))}
      </ul>
    </div>
  )
}
```

</Tabs.Tab>
<Tabs.Tab>

```tsx
'use client'

import { useSuspenseQuery } from '@suspensive/react-query'
import { relatedProductsQueryOptions } from './queries'

export const RelatedProducts = ({ categoryId }: { categoryId: string }) => {
  // ì„œë²„ì—ì„œ ë¯¸ë¦¬ ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ hydrateë©ë‹ˆë‹¤
  const { data: relatedProducts } = useSuspenseQuery(
    relatedProductsQueryOptions(categoryId)
  )

  return (
    <div>
      <h2>Related Products</h2>
      <ul>
        {relatedProducts.map((product) => (
          <li key={product.id}>{product.name}</li>
        ))}
      </ul>
    </div>
  )
}
```

</Tabs.Tab>
</Tabs>

ì´ íŒ¨í„´ì˜ ì¥ì :

1. **ë…ë¦½ì ì¸ Suspense ê²½ê³„**: ê° ì»´í¬ë„ŒíŠ¸ê°€ ë…ë¦½ì ìœ¼ë¡œ ìŠ¤íŠ¸ë¦¬ë°ë˜ì–´, `ProductInfo`ê°€ ë¨¼ì € ì¤€ë¹„ë˜ë©´ ë¨¼ì € ë Œë”ë§ë©ë‹ˆë‹¤
2. **ê°™ì€ queryClient ê³µìœ **: ìºì‹œê°€ ê³µìœ ë˜ì–´ `product` ë°ì´í„°ë¥¼ ì¬ì‚¬ìš©í•©ë‹ˆë‹¤
3. **Dependent queries ì§€ì›**: `product` ê²°ê³¼ì˜ `categoryId`ë¥¼ `relatedProductsQueryOptions`ì— ì „ë‹¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
4. **ì ì§„ì  ë Œë”ë§**: ê° ì»´í¬ë„ŒíŠ¸ê°€ ì¤€ë¹„ë˜ëŠ” ëŒ€ë¡œ ìˆœì°¨ì ìœ¼ë¡œ ìŠ¤íŠ¸ë¦¬ë°ë©ë‹ˆë‹¤

## ì˜ˆì œ

Next.js streamingê³¼ í•¨ê»˜ `QueriesHydration`ë¥¼ ì‚¬ìš©í•˜ëŠ” ì‹¤ì œ ì˜ˆì œì…ë‹ˆë‹¤:

![Next.js Streaming React Query Example](/img/next-streaming-react-query-example.gif)

- **[ë¼ì´ë¸Œ ë°ëª¨](https://next-streaming-react-query.suspensive.org)**: ì‹¤ì œ ë™ì‘ í™•ì¸
- **[ì†ŒìŠ¤ ì½”ë“œ](https://github.com/toss/suspensive/tree/main/examples/next-streaming-react-query)**: ì „ì²´ êµ¬í˜„ ì½”ë“œ í™•ì¸

**íŒ**: ë¼ì´ë¸Œ ë°ëª¨ì—ì„œ "4. no error (Best Practice)" ì¼€ì´ìŠ¤ë¥¼ í™•ì¸í•˜ê³  ë¸Œë¼ìš°ì €ì˜ ê°œë°œìë„êµ¬ ë„¤íŠ¸ì›Œí¬ íƒ­ì„ ì—´ì–´ë³´ì„¸ìš”. ì„œë²„ì—ì„œ ì„±ê³µì ìœ¼ë¡œ prefetchë˜ì–´ í´ë¼ì´ì–¸íŠ¸ì— hydrateëœ ë°ì´í„°ì´ê¸° ë•Œë¬¸ì— fetch ìš”ì²­ì´ ë°œìƒí•˜ì§€ ì•ŠëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ê²ƒì´ `QueriesHydration`ì˜ íš¨ìœ¨ì„±ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.

## SSR ë¹„í™œì„±í™”í•˜ê¸°

ë§Œì•½ íŠ¹ì • ì»´í¬ë„ŒíŠ¸ì—ì„œ ì„œë²„ ì‚¬ì´ë“œ ë Œë”ë§ì„ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë ¤ë©´, `<Suspense/>`ì— `clientOnly` propì„ ì¶”ê°€í•˜ê¸°ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤. ì´ ê²½ìš° ì„œë²„ì—ì„œ ë°ì´í„°ë¥¼ prefetchí•˜ì§€ ì•Šìœ¼ë¯€ë¡œ `QueriesHydration`ë„ í•„ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:

```tsx /QueriesHydration/
import { QueriesHydration } from '@suspensive/react-query'
import { Suspense } from '@suspensive/react'
import { userQueryOptions, postsQueryOptions } from './queries'
import { UserProfile, PostList } from './_components'

const PostsPage = ({ userId }: { userId: number }) => {
  return (
    <>
      {/* UserProfileì€ SSRì„ ê±´ë„ˆë›°ê³  í´ë¼ì´ì–¸íŠ¸ì—ì„œë§Œ ë Œë”ë§ë©ë‹ˆë‹¤ */}
      <Suspense clientOnly fallback={<div>Loading user...</div>}>
        <UserProfile userId={userId} />
      </Suspense>
      {/* PostListëŠ” ì„œë²„ì—ì„œ prefetchë˜ê³  ë Œë”ë§ë©ë‹ˆë‹¤ */}
      <Suspense fallback={<div>Loading posts...</div>}>
        <QueriesHydration queries={[postsQueryOptions(userId)]}>
          <PostList userId={userId} />
        </QueriesHydration>
      </Suspense>
    </>
  )
}
```

`clientOnly` propì„ ì‚¬ìš©í•˜ë©´:

- í•´ë‹¹ Suspense ê²½ê³„ ë‚´ì˜ ì»´í¬ë„ŒíŠ¸ëŠ” ì„œë²„ì—ì„œ ë Œë”ë§ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤
- í´ë¼ì´ì–¸íŠ¸ì—ì„œë§Œ ë°ì´í„°ë¥¼ í˜ì¹­í•˜ê³  ë Œë”ë§í•©ë‹ˆë‹¤
- ì„œë²„ ì‚¬ì´ë“œ prefetchê°€ í•„ìš” ì—†ìœ¼ë¯€ë¡œ `QueriesHydration`ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ë„ ë©ë‹ˆë‹¤

## ë²„ì „ë³„ ì°¨ì´ì 

### @tanstack/react-query v5

`@tanstack/react-query` v5ì—ì„œëŠ” `HydrationBoundary` ì»´í¬ë„ŒíŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

```tsx
import { HydrationBoundary } from '@tanstack/react-query'
import { QueriesHydration } from '@suspensive/react-query'

// QueriesHydrationëŠ” ë‚´ë¶€ì ìœ¼ë¡œ HydrationBoundaryë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤
```

### @tanstack/react-query v4

`@tanstack/react-query` v4ì—ì„œëŠ” `Hydrate` ì»´í¬ë„ŒíŠ¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

```tsx
import { Hydrate } from '@tanstack/react-query'
import { QueriesHydration } from '@suspensive/react-query'

// QueriesHydrationëŠ” ë‚´ë¶€ì ìœ¼ë¡œ Hydrateë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤
```

## ì£¼ì˜ì‚¬í•­

- ì´ ì»´í¬ë„ŒíŠ¸ëŠ” **async ì„œë²„ ì»´í¬ë„ŒíŠ¸**ì…ë‹ˆë‹¤.
- React Server Componentsë¥¼ ì§€ì›í•˜ëŠ” í”„ë ˆì„ì›Œí¬(Next.js 13+ App Router ë“±)ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
- ëª¨ë“  ì¿¼ë¦¬ëŠ” `queryKey`ë¥¼ ë°˜ë“œì‹œ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.

### ë²„ì „ ê¸°ë¡

| Version | Changes                                               |
| ------- | ----------------------------------------------------- |
| v3.14.0 | `<QueriesHydration/>`ê°€ ì‹¤í—˜ ê¸°ëŠ¥ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. |
