import { Callout } from '@/components'

# getQueryClient

<Callout type='experimental'>

`getQueryClient`ëŠ” ì‹¤í—˜ ê¸°ëŠ¥ì´ë¯€ë¡œ ì¸í„°í˜ì´ìŠ¤ê°€ ë³€ê²½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

</Callout>

ì„œë²„ í™˜ê²½ì—ì„œ ì•ˆì „í•˜ê²Œ QueryClient ì¸ìŠ¤í„´ìŠ¤ë¥¼ ê´€ë¦¬í•˜ëŠ” ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ì…ë‹ˆë‹¤.

- **ì„œë²„ í™˜ê²½**: ê° ìš”ì²­ë§ˆë‹¤ ìƒˆë¡œìš´ QueryClient ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±
- **ë¸Œë¼ìš°ì € í™˜ê²½**: ì‹±ê¸€í†¤ QueryClient ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë°˜í™˜ (ì—†ìœ¼ë©´ ìƒì„±)

ì´ íŒ¨í„´ì€ Next.jsì™€ ê°™ì€ SSR í”„ë ˆì„ì›Œí¬ì—ì„œ React Queryë¥¼ ì˜¬ë°”ë¥´ê²Œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ í•„ìˆ˜ì ì…ë‹ˆë‹¤. ì„œë²„ì—ì„œ ìš”ì²­ ê°„ QueryClient ìƒíƒœë¥¼ ê³µìœ í•˜ì§€ ì•Šìœ¼ë©´ì„œ, ë¸Œë¼ìš°ì €ì—ì„œëŠ” ë¦¬ë Œë”ë§ ê°„ ìºì‹œë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìœ ì§€í•©ë‹ˆë‹¤.

<Callout type='important'>

ì„œë²„ì—ì„œ QueryClientë¥¼ ìš”ì²­ ê°„ ê³µìœ í•˜ë©´ **ì‹¬ê°í•œ ë³´ì•ˆ ì·¨ì•½ì **ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `getQueryClient`ëŠ” ê° ìš”ì²­ë§ˆë‹¤ ìƒˆë¡œìš´ QueryClient ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ì—¬ ì‚¬ìš©ì ê°„ ë°ì´í„° ëˆ„ìˆ˜ì™€ ë¯¼ê°í•œ ì •ë³´ ë…¸ì¶œì„ ë°©ì§€í•©ë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ ì•„ë˜ [ì„œë²„ í™˜ê²½ ë™ì‘](#ì„œë²„-í™˜ê²½-ë™ì‘) ì„¹ì…˜ì„ ì°¸ê³ í•˜ì„¸ìš”.

</Callout>

## ê¸°ë³¸ ì‚¬ìš©ë²•

```tsx /getQueryClient/
import { getQueryClient } from '@suspensive/react-query'
import { QueryClientProvider } from '@tanstack/react-query'

function Providers({ children }: { children: React.ReactNode }) {
  const queryClient = getQueryClient()
  return (
    <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
  )
}
```

## ì„¤ì •

`QueryClientConfig`ë¥¼ ì „ë‹¬í•˜ì—¬ QueryClient ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```tsx /getQueryClient/
import { getQueryClient } from '@suspensive/react-query'
import { QueryClientProvider } from '@tanstack/react-query'

function Providers({ children }: { children: React.ReactNode }) {
  const queryClient = getQueryClient({
    defaultOptions: {
      queries: {
        staleTime: 5000,
        retry: 3,
      },
    },
  })
  return (
    <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
  )
}
```

<Callout type='warning'>

**ë¸Œë¼ìš°ì € í™˜ê²½ ë™ì‘**

ë¸Œë¼ìš°ì € í™˜ê²½ì—ì„œëŠ” config íŒŒë¼ë¯¸í„°ê°€ ì´ˆê¸° QueryClient ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•  ë•Œë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤. ì´í›„ ë‹¤ë¥¸ configë¡œ í˜¸ì¶œí•´ë„ ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ê°€ ë°˜í™˜ë˜ë©° ìƒˆë¡œìš´ configëŠ” ë¬´ì‹œë©ë‹ˆë‹¤. ì´ëŠ” ë¦¬ë Œë”ë§ ê°„ ì•ˆì •ì ì¸ ì‹±ê¸€í†¤ì„ ìœ ì§€í•˜ê¸° ìœ„í•œ ì˜ë„ì ì¸ ë™ì‘ì…ë‹ˆë‹¤.

</Callout>

## ì„œë²„ í™˜ê²½ ë™ì‘

### ë³´ì•ˆ ë¬¸ì œ ë°©ì§€ (ìµœìš°ì„ )

ì„œë²„ì—ì„œ QueryClientë¥¼ ìš”ì²­ ê°„ ê³µìœ í•˜ë©´ ì‹¬ê°í•œ ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

- **ì‚¬ìš©ì ê°„ ë°ì´í„° ëˆ„ìˆ˜**: í•œ ì‚¬ìš©ìì˜ ë°ì´í„°ê°€ ë‹¤ë¥¸ ì‚¬ìš©ìì—ê²Œ ë…¸ì¶œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤
- **ë¯¼ê°í•œ ì •ë³´ ë…¸ì¶œ**: ì¸ì¦ í† í°, ê°œì¸ ì •ë³´ ë“±ì´ ë‹¤ë¥¸ ì‚¬ìš©ìì˜ ìš”ì²­ì— í¬í•¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤
- **ì˜ëª»ëœ ìºì‹œ ìƒíƒœ**: ì´ì „ ìš”ì²­ì˜ ìºì‹œ ë°ì´í„°ê°€ ë‹¤ìŒ ìš”ì²­ì— ì˜ëª» ë°˜í™˜ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤

`getQueryClient`ëŠ” ê° ìš”ì²­ë§ˆë‹¤ ìƒˆë¡œìš´ QueryClient ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•¨ìœ¼ë¡œì¨ ì´ëŸ¬í•œ ë³´ì•ˆ ë¬¸ì œë¥¼ ì™„ì „íˆ ë°©ì§€í•©ë‹ˆë‹¤.

> ğŸ’¡ **ê´€ë ¨ ë¬¸ì„œ**: ì„œë²„ì—ì„œ QueryClientë¥¼ ìš”ì²­ ê°„ ê³µìœ í•˜ë©´ ì•ˆ ë˜ëŠ” ì´ìœ ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ [TanStack Query SSR ê°€ì´ë“œ - Initial Setup](https://tanstack.com/query/latest/docs/framework/react/guides/ssr#initial-setup) ì„¹ì…˜ì„ ì°¸ê³ í•˜ì„¸ìš”.

### OOM ë°©ì§€ë¥¼ ìœ„í•œ ìºì‹œ ì œê±° ì‹œê°„ ì„¤ì •

ì„œë²„ í™˜ê²½ì—ì„œ `getQueryClient`ëŠ” ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ì™€ OOM(Out of Memory) ì˜¤ë¥˜ë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•´ QueryClient ìºì‹œì—ì„œ ì¿¼ë¦¬ ë°ì´í„°ë¥¼ ì œê±°í•˜ëŠ” ì‹œê°„ì„ `Infinity`ë¡œ ì„¤ì •í•©ë‹ˆë‹¤. ì´ëŠ” ì„œë²„ê°€ ë§ì€ ë™ì‹œ ìš”ì²­ì„ ì²˜ë¦¬í•  ë•Œ ë°œìƒí•  ìˆ˜ ìˆëŠ” ë©”ëª¨ë¦¬ ë¬¸ì œë¥¼ í•´ê²°í•˜ê¸° ìœ„í•œ ì¶”ê°€ì ì¸ ì•ˆì „ ì¡°ì¹˜ì…ë‹ˆë‹¤.

`gcTime`(v5) ë˜ëŠ” `cacheTime`(v4)ì€ TanStack Queryê°€ QueryClientì˜ ìºì‹œì—ì„œ ì¿¼ë¦¬ ë°ì´í„°ë¥¼ ì œê±°í•˜ê¸°ê¹Œì§€ì˜ ì‹œê°„ì„ ì˜ë¯¸í•©ë‹ˆë‹¤. ì„œë²„ì—ì„œ ì´ ê°’ì„ `Infinity`ë¡œ ì„¤ì •í•˜ë©´:

- ìºì‹œì—ì„œ ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ ì œê±°ë˜ì§€ ì•Šì•„ ìš”ì²­ ì™„ë£Œ ì „ê¹Œì§€ ë°ì´í„°ê°€ ìœ ì§€ë©ë‹ˆë‹¤
- TanStack Query ë‚´ë¶€ì—ì„œ [`isValidTimeout`](https://github.com/TanStack/query/blob/main/packages/query-core/src/utils.ts) ê²€ì‚¬ë¥¼ í†µí•´ [`scheduleGc`](https://github.com/TanStack/query/blob/main/packages/query-core/src/removable.ts#L13-L21)ì—ì„œ `setTimeout` ìŠ¤ì¼€ì¤„ë§ì´ ë°©ì§€ë˜ì–´, ë§ì€ ë™ì‹œ ìš”ì²­ ì‹œ ë°œìƒí•  ìˆ˜ ìˆëŠ” `setTimeout`ìœ¼ë¡œ ì¸í•œ ì„±ëŠ¥ ì €í•˜ë¥¼ ì™„ì „íˆ ì œê±°í•©ë‹ˆë‹¤

ì´ ë™ì‘ì€ **ìë™ì´ë©° ì¬ì •ì˜í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤** - configì—ì„œ ìºì‹œ ì œê±° ì‹œê°„ì„ ë‹¤ë¥¸ ê°’ìœ¼ë¡œ ì œê³µí•˜ë”ë¼ë„, ì„œë²„ì—ì„œëŠ” `Infinity`ë¡œ ì„¤ì •ë©ë‹ˆë‹¤. (v4ì—ì„œëŠ” `cacheTime`, v5ì—ì„œëŠ” `gcTime` ì˜µì…˜ì„ ì‚¬ìš©í•©ë‹ˆë‹¤. ë²„ì „ë³„ ì°¨ì´ëŠ” ì•„ë˜ ì„¹ì…˜ì„ ì°¸ê³ í•˜ì„¸ìš”.)

> ğŸ’¡ **ê´€ë ¨ ë¬¸ì„œ**: ì„œë²„ì—ì„œì˜ ë†’ì€ ë©”ëª¨ë¦¬ ì†Œë¹„ì™€ ì„œë²„ì—ì„œ `gcTime`ì´ ê¸°ë³¸ì ìœ¼ë¡œ `Infinity`ë¡œ ì„¤ì •ë˜ëŠ” ì´ìœ ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ [TanStack Query SSR ê°€ì´ë“œ - ì„œë²„ì—ì„œì˜ ë†’ì€ ë©”ëª¨ë¦¬ ì†Œë¹„](https://tanstack.com/query/latest/docs/framework/react/guides/ssr#high-memory-consumption-on-server) ì„¹ì…˜ì„ ì°¸ê³ í•˜ì„¸ìš”.

```tsx /getQueryClient/
import { getQueryClient } from '@suspensive/react-query'

// ì„œë²„ í™˜ê²½
const queryClient = getQueryClient({
  defaultOptions: {
    queries: {
      // ì„œë²„ì—ì„œëŠ” ìºì‹œ ì œê±° ì‹œê°„ì´ Infinityë¡œ ì„¤ì •ë˜ì–´
      // ìš”ì²­ ì™„ë£Œ ì „ê¹Œì§€ ìºì‹œê°€ ìœ ì§€ë˜ê³  setTimeout ìŠ¤ì¼€ì¤„ë§ì´ ë°©ì§€ë©ë‹ˆë‹¤
      gcTime: 5000, // v5: ì„œë²„ì—ì„œëŠ” Infinityë¡œ ì¬ì •ì˜ë©ë‹ˆë‹¤
      // v4ì—ì„œëŠ” cacheTimeì´ ì‚¬ìš©ë˜ë©°, ë§ˆì°¬ê°€ì§€ë¡œ Infinityë¡œ ì¬ì •ì˜ë©ë‹ˆë‹¤
    },
  },
})

// ì„œë²„: ìºì‹œ ì œê±° ì‹œê°„ì€ í•­ìƒ Infinity (OOM ë°©ì§€)
// ë¸Œë¼ìš°ì €: ì œê³µëœ ê°’(ë˜ëŠ” ê¸°ë³¸ê°’)ì„ ì‚¬ìš©
```

### ìš”ì²­ë§ˆë‹¤ ìƒˆë¡œìš´ ì¸ìŠ¤í„´ìŠ¤

ì„œë²„ì—ì„œ `getQueryClient`ëŠ” ê° í˜¸ì¶œë§ˆë‹¤ ìƒˆë¡œìš´ QueryClient ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´:

- ê° ìš”ì²­ì´ ê²©ë¦¬ëœ ìºì‹œ ìƒíƒœë¥¼ ê°€ì§‘ë‹ˆë‹¤
- ë‹¤ë¥¸ ì‚¬ìš©ì ìš”ì²­ ê°„ ë°ì´í„° ëˆ„ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤
- ìš”ì²­ ì™„ë£Œ ì‹œ ì ì ˆí•œ ì •ë¦¬ê°€ ìˆ˜í–‰ë©ë‹ˆë‹¤

```tsx /getQueryClient/
// ì„œë²„ í™˜ê²½
const queryClient1 = getQueryClient()
const queryClient2 = getQueryClient()

// queryClient1 !== queryClient2 (ë‹¤ë¥¸ ì¸ìŠ¤í„´ìŠ¤)
```

## ë¸Œë¼ìš°ì € í™˜ê²½ ë™ì‘

### ì‹±ê¸€í†¤ íŒ¨í„´

ë¸Œë¼ìš°ì €ì—ì„œ `getQueryClient`ëŠ” ì—¬ëŸ¬ í˜¸ì¶œì— ê±¸ì³ ë™ì¼í•œ QueryClient ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤. ì´ë¥¼ í†µí•´:

- ë¦¬ë Œë”ë§ ê°„ ìºì‹œê°€ ìœ ì§€ë©ë‹ˆë‹¤
- ì¼ê´€ëœ ìƒíƒœ ê´€ë¦¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤
- ìµœì ì˜ ì„±ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤

```tsx /getQueryClient/
// ë¸Œë¼ìš°ì € í™˜ê²½
const queryClient1 = getQueryClient()
const queryClient2 = getQueryClient()

// queryClient1 === queryClient2 (ë™ì¼í•œ ì¸ìŠ¤í„´ìŠ¤)
```

## ì‚¬ìš© ì‚¬ë¡€

### Next.js App Router

```tsx /getQueryClient/
// app/providers.tsx
'use client'

import { getQueryClient } from '@suspensive/react-query'
import { QueryClientProvider } from '@tanstack/react-query'
import { ReactNode } from 'react'

export function Providers({ children }: { children: ReactNode }) {
  const queryClient = getQueryClient()
  return (
    <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
  )
}
```

```tsx
// app/layout.tsx
import { Providers } from './providers'

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html lang="en">
      <body>
        <Providers>{children}</Providers>
      </body>
    </html>
  )
}
```

### ì»¤ìŠ¤í…€ ì„¤ì •ê³¼ í•¨ê»˜ ì‚¬ìš©

```tsx /getQueryClient/
import { getQueryClient } from '@suspensive/react-query'
import { QueryClientProvider } from '@tanstack/react-query'

function Providers({ children }: { children: React.ReactNode }) {
  const queryClient = getQueryClient({
    defaultOptions: {
      queries: {
        staleTime: 1000 * 60 * 5, // 5ë¶„
        gcTime: 1000 * 60 * 10, // 10ë¶„ (v5)
        // cacheTime: 1000 * 60 * 10, // 10ë¶„ (v4)
        retry: 2,
        refetchOnWindowFocus: false,
      },
      mutations: {
        retry: 1,
      },
    },
  })

  return (
    <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
  )
}
```

## ë²„ì „ ì°¨ì´

### @tanstack/react-query v4

v4ì—ì„œëŠ” ìºì‹œ ì‹œê°„ ì˜µì…˜ì´ `cacheTime`ì´ë¼ê³  ë¶ˆë¦½ë‹ˆë‹¤:

```tsx
// ì„œë²„: cacheTimeì€ ìë™ìœ¼ë¡œ Infinityë¡œ ì„¤ì •ë©ë‹ˆë‹¤
const queryClient = getQueryClient({
  defaultOptions: {
    queries: {
      cacheTime: 5000, // ì„œë²„ì—ì„œëŠ” Infinityë¡œ ì¬ì •ì˜ë©ë‹ˆë‹¤
    },
  },
})
```

### @tanstack/react-query v5

v5ì—ì„œëŠ” ìºì‹œ ì‹œê°„ ì˜µì…˜ì´ `gcTime` (garbage collection time)ì´ë¼ê³  ë¶ˆë¦½ë‹ˆë‹¤:

```tsx
// ì„œë²„: gcTimeì€ ìë™ìœ¼ë¡œ Infinityë¡œ ì„¤ì •ë©ë‹ˆë‹¤
const queryClient = getQueryClient({
  defaultOptions: {
    queries: {
      gcTime: 5000, // ì„œë²„ì—ì„œëŠ” Infinityë¡œ ì¬ì •ì˜ë©ë‹ˆë‹¤
    },
  },
})
```

## ì¤‘ìš” ì‚¬í•­

- **ì„œë²„ ì•ˆì „ì„±**: SSR í™˜ê²½ì—ì„œ `new QueryClient()`ë¥¼ ì§ì ‘ ìƒì„±í•˜ëŠ” ëŒ€ì‹  í•­ìƒ `getQueryClient`ë¥¼ ì‚¬ìš©í•˜ì—¬ ì ì ˆí•œ ìš”ì²­ ê²©ë¦¬ì™€ OOM ë°©ì§€ë¥¼ ë³´ì¥í•˜ì„¸ìš”.

- **ë¸Œë¼ìš°ì € ì‹±ê¸€í†¤**: ë¸Œë¼ìš°ì € ì¸ìŠ¤í„´ìŠ¤ëŠ” ì‹±ê¸€í†¤ì´ë¯€ë¡œ ì²« ë²ˆì§¸ í˜¸ì¶œ ì´í›„ì˜ config ë³€ê²½ì€ ë¬´ì‹œë©ë‹ˆë‹¤. ì²« ë²ˆì§¸ í˜¸ì¶œì—ì„œ QueryClientë¥¼ êµ¬ì„±í•˜ì„¸ìš”.

- **ìë™ OOM ë°©ì§€**: ì„œë²„ì—ì„œ ìºì‹œ ì œê±° ì‹œê°„ì„ `Infinity`ë¡œ ì¬ì •ì˜í•˜ëŠ” ê²ƒì€ ìë™ì´ë©° ë¹„í™œì„±í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ëŠ” ë©”ëª¨ë¦¬ ë¬¸ì œë¥¼ ë°©ì§€í•˜ê¸° ìœ„í•œ ì•ˆì „ ê¸°ëŠ¥ì…ë‹ˆë‹¤. (v4ì—ì„œëŠ” `cacheTime`, v5ì—ì„œëŠ” `gcTime` ì˜µì…˜ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.)
